<link rel="stylesheet" type="text/css" href="homeassistant/static/common.css" />
<script src="homeassistant/static/common.js"></script>
<script src="homeassistant/static/ifstate.js"></script>
<script type="text/javascript">
  RED.nodes.registerType("server-state-changed", {
    category: "home_assistant",
    color: "#038FC7",
    inputs: 0,
    outputs: 1,
    outputLabels: nodeVersion.ifStateLabels,
    icon: "arrow-right-bold-hexagon-outline.png",
    paletteLabel: "events: state",
    label: function() {
      return (
        this.name || `state_changed: ${this.entityidfilter || "all entities"}`
      );
    },
    labelStyle: nodeVersion.labelStyle,
    defaults: {
      name: { value: "" },
      server: { value: "", type: "server", required: true },
      version: { value: 1 },
      exposeToHomeAssistant: { value: false },
      haConfig: {
        value: [
          { property: "name", value: "" },
          { property: "icon", value: "" }
        ]
      },
      entityidfilter: { value: "", required: true },
      entityidfiltertype: { value: "exact" },
      outputinitially: { value: false },
      state_type: { value: "str" },
      haltifstate: { value: "" },
      halt_if_type: {},
      halt_if_compare: {},
      outputs: { value: 1 },
      output_only_on_state_change: { value: true }
    },
    oneditprepare: function() {
      const $entityidfilter = $("#node-input-entityidfilter");
      const $entityidfiltertype = $("#node-input-entityidfiltertype");
      const node = this;

      nodeVersion.check(this);
      haServer.init(node, "#node-input-server");
      exposeNode.init(node);

      $entityidfilter.val(this.entityidfilter);
      this.entityidfiltertype = this.entityidfiltertype || "substring";
      $entityidfiltertype.val(this.entityidfiltertype);

      haServer.autocomplete("entities", entities => {
        node.availableEntities = entities;
        $entityidfilter.autocomplete({
          source: node.availableEntities,
          minLength: 0
        });
      });

      if (this.state_type === undefined) {
        $("#node-input-state_type").val("str");
      }

      if (this.halt_if_compare === undefined) {
        $("#node-input-halt_if_compare").val("is");
      }

      ifState.init("#node-input-haltifstate", "#node-input-halt_if_compare");
    },
    oneditsave: function() {
      this.entityidfilter = $("#node-input-entityidfilter").val();
      let outputs = $("#node-input-haltifstate").val() ? 2 : 1;
      // Swap inputs for the new 'if state' location
      if (this.version === 0 && outputs === 2) {
        outputs = JSON.stringify({
          0: 1,
          1: 0
        });
      }
      $("#node-input-outputs").val(outputs);
      nodeVersion.update(this);
      this.haConfig = exposeNode.getValues();
    },
    oneditresize: function() {
      ifState.resize();
    }
  });
</script>

<script type="text/x-red" data-template-name="server-state-changed">
  <input type="hidden" id="node-input-version" />

  <!-- Name -->
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
      <input type="hidden" id="node-input-outputs"/>
  </div>

  <!-- Server -->
  <div class="form-row">
      <label for="node-input-server"><i class="fa fa-server"></i> Server</label>
      <input type="text" id="node-input-server" />
  </div>

  <!-- Entity ID Filter and Filter Type -->
  <div class="form-row">
      <label for="node-input-entityidfilter"><i class="fa fa-tag"></i> Entity ID</label>

      <input type="text" id="node-input-entityidfilter" style="width: 50%;" />

      <select type="text" id="node-input-entityidfiltertype" style="width: 20%;">
          <option value="exact">Exact</option>
          <option value="substring">Substring</option>
          <option value="regex">Regex</option>
      </select>
  </div>


  <div class="form-row">
    <label for="node-input-haltifstate"><i class="fa fa-check-square"></i> If State</label>
    <div style="width: 70%;display: inline-block;">
      <select type="text" id="node-input-halt_if_compare" style="width: auto;">
        <option value="is">is</option>
        <option value="is_not">is not</option>
        <option value="lt">&lt;</option>
        <option value="lte">&lt;=</option>
        <option value="gt">&gt;</option>
        <option value="gte">&gt;=</option>
        <option value="includes">in</option>
        <option value="does_not_include">not in</option>
        <option value="jsonata">JSONata</option>
      </select>
      <input type="text" id="node-input-haltifstate" />
    </div>
    <input type="hidden" id="node-input-halt_if_type" />
    <p id="error-if-state" class="ui-state-error">ifState.js not loaded</p>
  </div>


  <div class="form-row">
      <label for="node-input-state_type"><i class="fa fa-tint"></i> State Type</label>
      <select type="text" id="node-input-state_type" style="width: auto;">
          <option value="str">String</option>
          <option value="num">Number</option>
          <option value="habool">Boolean</option>
      </select>
  </div>

  <div class="form-row">
      <input type="checkbox" id="node-input-output_only_on_state_change" style="display: inline-block; width: auto; vertical-align: top;margin-left: 105px;">
      <label for="node-input-output_only_on_state_change" style="width: auto;">Output only on state change</label>
  </div>

  <div class="form-row">
      <input type="checkbox" id="node-input-outputinitially" style="display: inline-block; width: auto; vertical-align: top;margin-left: 105px;">
      <label for="node-input-outputinitially" style="width: auto;">Output on Connect</label>
  </div>
</script>

<!-- Documentation in this file is generated from /docs/node/events-state.md -->
<script type="text/x-red" data-help-name="server-state-changed">
  <html>
    <head></head>
    <body>
      <p>Outputs state_changed event types sent from Home Assistant</p>
      <p>
        The autocomplete will open to allow easier selection in the case you want
        a specific entity however the actual match is a substring match so no
        validation is done
      </p>
      <h3>Configuration:</h3>
      <dl class="message-properties">
        <dt>
          Entity ID (<strong>required</strong>)<span class="property-type"
            >string|regex</span
          >
        </dt>
        <dd>matches for entity_id field</dd>
        <dt>
          Entity ID Filter Types (<strong>required</strong>)<span
            class="property-type"
            >string</span
          >
        </dt>
        <ul>
          <li>Values: <code>exact|substring|regex</code></li>
          <li>Default: <code>exact</code></li>
        </ul>
        <dd>Substring can be a comma-delimited list.</dd>
        <dt>If State<span class="property-type">string</span></dt>
        <dd>
          If the conditional is evaluated as true send the message to the first
          output otherwise send it to the second output. If blank there will only
          be one output.
        </dd>
        <dd><strong>Also see:</strong></dd>
        <ul>
          <li>
            <a
              href="https://zachowj.github.io/node-red-contrib-home-assistant-websocket/guide/conditionals.html"
              >Conditionals</a
            >
          </li>
        </ul>
        <dt>State Type<span class="property-type">string</span></dt>
        <ul>
          <li>Values: <code>string|number|boolean</code></li>
          <li>Default: <code>string</code></li>
        </ul>
        <dd>
          Convert the state of the entity to the selected type. Boolean will be
          converted to true based on if the string is equal by default to
          (<code>y|yes|true|on|home|open</code>). Original value stored in
          msg.data.original_state
        </dd>
        <dt>
          Output only on state change<span class="property-type">boolean</span>
        </dt>
        <dd>Output only when the state has changed and not on startup/deploy</dd>
        <dt>Output on Connect<span class="property-type">boolean</span></dt>
        <dd>Output once on startup/deploy</dd>
        <dt>
          Expose to Home Assistant<span class="property-type">boolean</span>
        </dt>
        <dd>
          Creates a switch within Home Assistant to enable/disable this node. This
          feature requires
          <a href="https://github.com/zachowj/hass-node-red"
            >Node-RED custom integration</a
          >
          to be installed in Home Assistant
        </dd>
        <dt>Output<span class="property-type"></span></dt>
        <dt>topic<span class="property-type">string</span></dt>
        <dd>The entity ID that triggered the event.</dd>
        <dt>payload<span class="property-type">string|number|boolean</span></dt>
        <dd>The current state of the entity that triggered the event.</dd>
        <dt>data<span class="property-type">Object</span></dt>
        <dd>original event object from Home Assistant</dd>
        <dd>Example output of the data property:</dd>
        <pre><code class="language-json">{
    &quot;entity_id&quot;: &quot;light.kitchen&quot;,
    &quot;old_state&quot;: {
      &quot;entity_id&quot;: &quot;light.kitchen&quot;,
      &quot;state&quot;: &quot;off&quot;,
      &quot;attributes&quot;: {
        &quot;friendly_name&quot;: &quot;Kitchen Light&quot;,
        &quot;icon&quot;: &quot;mdi:light-switch&quot;
      },
      &quot;last_changed&quot;: &quot;2019-12-29T04:49:50.230660+00:00&quot;,
      &quot;last_updated&quot;: &quot;2019-12-29T04:49:50.230660+00:00&quot;,
      &quot;context&quot;: {
        &quot;id&quot;: &quot;3a639379992d430595e3e9c73fb349e1&quot;,
        &quot;parent_id&quot;: null,
        &quot;user_id&quot;: null
      }
    },
    &quot;new_state&quot;: {
      &quot;entity_id&quot;: &quot;light.kitchen&quot;,
      &quot;state&quot;: &quot;on&quot;,
      &quot;attributes&quot;: {
        &quot;brightness&quot;: 118,
        &quot;friendly_name&quot;: &quot;Kitchen Light&quot;,
        &quot;icon&quot;: &quot;mdi:light-switch&quot;
      },
      &quot;last_changed&quot;: &quot;2019-12-29T05:28:44.238349+00:00&quot;,
      &quot;last_updated&quot;: &quot;2019-12-29T05:28:44.238349+00:00&quot;,
      &quot;context&quot;: {
        &quot;id&quot;: &quot;8a147f61a375489284ef7a7715a6a8f2&quot;,
        &quot;parent_id&quot;: null,
        &quot;user_id&quot;: null
      },
      &quot;timeSinceChangedMs&quot;: 12
    }
  }
  </code></pre>
      </dl>
    </body>
  </html>
</script>
