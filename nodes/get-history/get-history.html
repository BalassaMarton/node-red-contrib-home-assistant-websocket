<link rel="stylesheet" type="text/css" href="homeassistant/static/common.css" />
<script src="homeassistant/static/common.js"></script>
<script type="text/javascript">
  RED.nodes.registerType("api-get-history", {
    category: "home_assistant",
    color: "#52C0F2",
    inputs: 1,
    outputs: 1,
    icon: "history.png",
    paletteLabel: "get history",
    label: function() {
      if (this.name) {
        return this.name;
      }
      if (this.useRelativeTime && this.relativeTime) {
        return this.relativeTime;
      } else if (this.startdate) {
        const startdate = new Date(this.startdate);
        return `${startdate.toLocaleDateString()} ${startdate.toLocaleTimeString()}`;
      }
      return "get history";
    },
    labelStyle: nodeVersion.labelStyle,
    defaults: {
      name: { value: "" },
      server: { value: "", type: "server", required: true },
      startdate: { value: "" },
      enddate: { value: "" },
      entityid: { value: "" },
      entityidtype: { value: "" },
      useRelativeTime: { value: false },
      relativeTime: { value: "" },
      flatten: { value: true },
      output_type: { value: "array" },
      output_location_type: { value: "msg" },
      output_location: { value: "payload" }
    },
    oneditprepare: function() {
      const NODE = this;
      const $entityIdField = $("#entity_id");
      $entityIdField.val(this.entityid);
      NODE.entityidtype = NODE.entityidtype || "is";
      $("#node-input-entityidtype").val(NODE.entityidtype);

      haServer.init(NODE, "#node-input-server");
      let availableEntities = [];
      haServer.autocomplete("entities", entities => {
        availableEntities = entities;

        $entityIdField.autocomplete({
          source: availableEntities,
          minLength: 0
        });
      });

      $("#node-input-useRelativeTime").on("change", function() {
        if (this.checked) {
          $(".relative_row").show();
          $(".date_row").hide();
        } else {
          $(".relative_row").hide();
          $(".date_row").show();
        }
      });

      if (this.output_location === undefined) {
        $("#node-input-output_location").val("payload");
      }
      if (this.output_type === undefined) {
        $("#node-input-output_type").val("array");
      }

      $("#node-input-output_location").typedInput({
        types: ["msg", "flow", "global"],
        typeField: "#node-input-output_location_type"
      });

      $("#node-input-output_type")
        .on("change", e =>
          $(".output-option").toggle(e.target.value === "array")
        )
        .trigger("change");
    },
    oneditsave: function() {
      this.entityid = $("#entity_id")
        .val()
        .trim();
    }
  });
</script>

<script type="text/html" data-template-name="api-get-history">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label for="node-input-server"><i class="fa fa-server"></i> Server</label>
    <input type="text" id="node-input-server" />
  </div>

  <!-- Comparator Selection -->
  <div class="form-row">
    <label for="entity_id"><i class="fa fa-date"></i> Entity ID</label>

    <select type="text" id="node-input-entityidtype" style="width: 80px;">
      <option value="is">Is</option>
      <option value="includes">Includes</option>
    </select>

    <input type="text" id="entity_id" style="width: 52%;"/>
  </div>

  <div class="form-row">
    <input type="checkbox" id="node-input-useRelativeTime" style="display: inline-block; width: auto; vertical-align: top;margin-left: 105px;">&nbsp;
    <label for="node-input-useRelativeTime" style="width: auto;">Use Relative Time</label>
  </div>

  <div class="form-row relative_row">
    <label for="node-input-relativeTime"><i class="fa fa-date"></i> In the Last</label>
    <input type="text" id="node-input-relativeTime" autofocus="autofocus" placeholder="20 minutes" />
  </div>

  <div class="form-row date_row">
    <label for="node-input-startdate"><i class="fa fa-date"></i> Start Date</label>
    <input type="text" id="node-input-startdate" autofocus="autofocus" />
  </div>

  <div class="form-row date_row">
    <label for="node-input-enddate"><i class="fa fa-date"></i> End Date</label>
    <input type="text" id="node-input-enddate" />
  </div>

  <div class="form-row form-tips date_row">
    <ul>
      <li>dates must be in ISO format</li>
      <li>example: "2018-01-27T13:00:00+00:00"</li>
    </ul>
  </div>

  <div class="form-row form-tips relative_row">
    <p><code>timestring</code> will parse the following keywords into time values:</p>
    <ol>
      <li><code>ms, milli, millisecond, milliseconds</code> - will parse to milliseconds</li>
      <li><code>s, sec, secs, second, seconds</code> - will parse to seconds</li>
      <li><code>m, min, mins, minute, minutes</code> - will parse to minutes</li>
      <li><code>h, hr, hrs, hour, hours</code> - will parse to hours</li>
      <li><code>d, day, days</code> - will parse to days</li>
      <li><code>w, week, weeks</code> - will parse to weeks</li>
      <li><code>mon, mth, mths, month, months</code> - will parse to months</li>
      <li><code>y, yr, yrs, year, years</code> - will parse to years</li>
    </ol>
  </div>

  <div class="form-row">
    <input type="checkbox" id="node-input-flatten" style="display: inline-block; width: auto; vertical-align: top;margin-left: 105px;">&nbsp;
    <label for="node-input-flatten" style="width: auto;">Flatten Results</label>
  </div>

  <div class="form-row">
    <label for="node-input-output_type">Output Type</label>
    <select id="node-input-output_type">
      <option value="array">Array</option>
      <option value="split">Split</option>
    </select>
  </div>

  <div class="form-row output-option" id="output_location">
    <label for="node-input-output_location">Output Location</label>
    <input type="hidden" id="node-input-output_location_type" />
    <input type="text" id="node-input-output_location" />
  </div>
</script>

<!-- Documentation in this file is generated from /docs/node/get-history.md -->
<script type="text/html" data-help-name="api-get-history"></script>
