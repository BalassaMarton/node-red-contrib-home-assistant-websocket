<link rel="stylesheet" type="text/css" href="homeassistant/static/common.css" />
<script src="homeassistant/static/common.js"></script>
<script src="homeassistant/static/ifstate.js"></script>
<script type="text/javascript">
  RED.nodes.registerType("api-current-state", {
    category: "home_assistant",
    color: "#52C0F2",
    inputs: 1,
    outputs: 1,
    outputLabels: nodeVersion.ifStateLabels,
    icon: "code.png",
    paletteLabel: "current state",
    label: function() {
      return this.name || `current_state: ${this.entity_id}`;
    },
    labelStyle: nodeVersion.labelStyle,
    defaults: {
      name: { value: "" },
      server: { value: "", type: "server", required: true },
      version: { value: 1 },
      outputs: { value: 1 },
      halt_if: { value: "" },
      halt_if_type: { value: "str" },
      halt_if_compare: { value: "is" },
      override_topic: { value: false },
      entity_id: { value: "" },
      state_type: { value: "str" },
      state_location: { value: "payload" },
      override_payload: { value: "msg" }, // state location type
      entity_location: { value: "data" },
      override_data: { value: "msg" }, // entity location types
      blockInputOverrides: { value: false }
    },
    oneditprepare: function() {
      nodeVersion.check(this);

      const $entityIdField = $("#entity_id");
      const $stateLocation = $("#node-input-state_location");
      const $entityLocation = $("#node-input-entity_location");

      const node = this;

      haServer.init(node, "#node-input-server");
      haServer.autocomplete("entities", entities => {
        node.availableEntities = entities;

        $entityIdField.autocomplete({
          source: node.availableEntities,
          minLength: 0
        });
      });

      $entityIdField.val(node.entity_id);

      // Handle backwards compatibility
      if (node.state_location === undefined) {
        $stateLocation.val("payload");
        $("#node-input-override_payload").val(
          node.override_payload === false ? "none" : "msg"
        );
      }
      if (node.entity_location === undefined) {
        $entityLocation.val("data");
        $("#node-input-override_data").val(
          node.override_data === false ? "none" : "msg"
        );
      }

      const NoneType = { value: "none", label: "None", hasValue: false };
      $stateLocation
        .typedInput({
          types: ["msg", "flow", "global", NoneType],
          typeField: "#node-input-override_payload"
        })
        .typedInput("width", "68%");
      $entityLocation
        .typedInput({
          types: ["msg", "flow", "global", NoneType],
          typeField: "#node-input-override_data"
        })
        .typedInput("width", "68%");

      if (node.state_type === undefined) {
        $("#node-input-state_type").val("str");
      }

      if (node.halt_if_compare === undefined) {
        $("#node-input-halt_if_compare").val("is");
      }

      ifState.init(
        "#node-input-halt_if",
        "#node-input-halt_if_compare",
        "currentState"
      );
    },
    oneditsave: function() {
      this.entity_id = $("#entity_id").val();
      let outputs = $("#node-input-halt_if").val() ? 2 : 1;
      // Swap inputs for the new 'if state' location
      if (this.version === 0 && outputs === 2) {
        outputs = JSON.stringify({ 0: 1, 1: 0 });
      }
      $("#node-input-outputs").val(outputs);
      nodeVersion.update(this);
    },
    oneditresize: function() {
      ifState.resize();
    }
  });
</script>

<script type="text/x-red" data-template-name="api-current-state">
  <input type="hidden" id="node-input-version" />

  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
      <input type="hidden" id="node-input-outputs"/>
  </div>

  <div class="form-row">
      <label for="node-input-server"><i class="fa fa-server"></i> Server</label>
      <input type="text" id="node-input-server" />
  </div>

  <div class="form-row">
      <label for="entity_id"><i class="fa fa-cube"></i> Entity ID</label>
      <input type="text" id="entity_id">
  </div>

  <div class="form-row">
    <label for="node-input-halt_if_compare"><i class="fa fa-check-square"></i> If State</label>
    <div style="width: 70%;display: inline-block;">
      <select type="text" id="node-input-halt_if_compare" style="width: auto;">
        <option value="is">is</option>
        <option value="is_not">is not</option>
        <option value="lt">&lt;</option>
        <option value="lte">&lt;=</option>
        <option value="gt">&gt;</option>
        <option value="gte">&gt;=</option>
        <option value="includes">in</option>
        <option value="does_not_include">not in</option>
        <option value="jsonata">JSONata</option>
      </select>
      <input type="text" id="node-input-halt_if" />
    </div>
    <input type="hidden" id="node-input-halt_if_type" />
    <p id="error-if-state" class="ui-state-error">ifState.js not loaded</p>
  </div>

  <div class="form-row">
      <label for="node-input-state_type"><i class="fa fa-tint"></i> State Type</label>
      <select type="text" id="node-input-state_type" style="width: auto;">
          <option value="str">String</option>
          <option value="num">Number</option>
          <option value="habool">Boolean</option>
      </select>
  </div>

  <div class="form-row" id="state_location">
    <label for="node-input-state_location">State Location</label>
    <input type="hidden" id="node-input-override_payload" />
    <input type="text" id="node-input-state_location" />
  </div>

  <div class="form-row" id="entity_location">
    <label for="node-input-entity_location">Entity Location</label>
    <input type="hidden" id="node-input-override_data" />
    <input type="text" id="node-input-entity_location" />
  </div>

  <div class="form-row checkbox-option">
      <input type="checkbox" id="node-input-override_topic">&nbsp;
      <label for="node-input-override_topic">Override Topic</label>
  </div>

  <div class="form-row checkbox-option">
      <input type="checkbox" id="node-input-blockInputOverrides">&nbsp;
      <label for="node-input-blockInputOverrides">Block Input Overrides</label>
  </div>
</script>

<!-- Documentation in this file is generated from /docs/node/current-state.md -->
<script type="text/x-red" data-help-name="api-current-state"></script>
