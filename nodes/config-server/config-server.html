<link rel="stylesheet" type="text/css" href="homeassistant/static/common.css" />
<script src="homeassistant/static/common.js"></script>
<script type="text/javascript">
  RED.nodes.registerType("server", {
    category: "config",
    defaults: {
      name: { value: "Home Assistant", required: false },
      legacy: { value: false },
      hassio: { value: false },
      rejectUnauthorizedCerts: { value: true },
      ha_boolean: { value: "y|yes|true|on|home|open" },
      connectionDelay: { value: true },
      cacheJson: { value: true }
    },
    credentials: {
      host: { value: "", required: true },
      access_token: { value: "", required: false }
    },
    icon: "home.png",
    label: function() {
      return this.name || this.url;
    },
    oneditprepare: function() {
      const $hassio = $("#node-config-input-hassio");
      const $host = $("#node-config-input-host");
      const $legacy = $("#node-config-input-legacy");

      if (this.ha_boolean === undefined) {
        $("#node-config-input-ha_boolean").val("y|yes|true|on|home|open");
      }

      // Backwards compatibility
      if (this.rejectUnauthorizedCerts === false) {
        $("#accept_unauthorized_certs").prop("checked", true);
      }
      if (this.connectionDelay === undefined) {
        $("#node-config-input-connectionDelay").prop("checked", true);
      }
      if (this.cacheJson === undefined) {
        $("#node-config-input-cacheJson").prop("checked", true);
      }

      if (
        !$hassio.prop("checked") &&
        $host.val() === "http://hassio/homeassistant"
      ) {
        $hassio.prop("checked", true);
      }

      function updateHassio() {
        $("#server-info").toggle(!$hassio.prop("checked"));
        $(".hassio").toggle($hassio.prop("checked"));
      }
      updateHassio();
      $hassio.on("click", function() {
        updateHassio();
      });

      function updateLegacy() {
        const tokenName = $legacy.prop("checked") ? "Password" : "Access Token";

        $("#access-token-label").html(
          '<i class="fa fa-user-secret"></i> ' + tokenName
        );
        $("#node-config-input-access_token").attr(
          "placeholder",
          tokenName.toLowerCase()
        );
      }
      updateLegacy();
      $legacy.on("click", function() {
        updateLegacy();
      });
    },
    oneditsave: function() {
      const hassio = $("#node-config-input-hassio").is(":checked");
      const $host = $("#node-config-input-host");
      const hostname = $host.val();

      if (hassio) {
        $host.val("http://hassio/homeassistant");
        this.legacy = false;
        this.rejectUnauthorizedCerts = true;
        // this.connectionDelay = $("#node-config-input-connectionDelay").is(
        //   ":checked"
        // );
      } else {
        const parser = document.createElement("a");
        parser.href = hostname;

        if (hostname !== parser.origin) {
          RED.notify("Invalid format of Base URL: " + hostname);
        }

        // Save the inverse of the checkbox
        this.rejectUnauthorizedCerts = !$("#accept_unauthorized_certs").prop(
          "checked"
        );
        this.connectionDelay = false;
      }
    }
  });
</script>

<script type="text/x-red" data-template-name="server">
  <div class="form-row">
      <label for="node-config-input-name" style="width: 120px"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-config-input-name" />
  </div>

  <div class="form-row">
      <input type="checkbox" id="node-config-input-hassio" style="width: auto;margin-left: 125px;vertical-align: top" />
      <label for="node-config-input-hassio" style="width: auto;"> I use the Hass.io Add-on</label>
  </div>

  <div class="form-row hassio">
    <input type="checkbox" id="node-config-input-connectionDelay" style="width: auto;margin-left: 125px;vertical-align: top" />
    <label for="node-config-input-connectionDelay" style="width: auto;"> Delay connection attempts</label>
  </div>

  <div id="server-info">
      <div class="form-row">
          <label for="node-config-input-host" style="width: 120px"><i class="fa fa-link"></i> Base URL</label>
          <input type="text" id="node-config-input-host" placeholder="http://localhost:8123" />
      </div>

      <div class="form-row">
          <label id="access-token-label" for="node-config-input-access_token" style="width: 120px"><i class="fa fa-user-secret"></i> Access Token</label>
          <input type="text" id="node-config-input-access_token" placeholder="access token" />
      </div>

      <div class="form-row">
          <input type="checkbox" id="node-config-input-legacy" style="width: auto;margin-left: 125px;vertical-align: top" />
          <label for="node-config-input-legacy" style="width: auto;"> Use Legacy API Password</label>
      </div>

      <div class="form-row">
          <input type="checkbox" id="accept_unauthorized_certs" style="width: auto;margin-left: 125px;vertical-align: top" />
          <label for="accept_unauthorized_certs" style="width: auto;"> Accept Unauthorized SSL Certificates</label>
      </div>
  </div>

  <div class="form-row">
    <label for="node-config-input-ha_boolean" style="width: 120px"><i class="fa fa-link"></i> State Boolean</label>
    <input type="text" id="node-config-input-ha_boolean" placeholder="y|yes|true|on|home|open" />
  </div>

  <div class="form-row">
    <input type="checkbox" id="node-config-input-cacheJson" style="width: auto;margin-left: 125px;vertical-align: top" />
    <label for="node-config-input-cacheJson" style="width: auto;"> Cache Autocomplete Results</label>
  </div>
</script>

<!-- Documentation in this file is generated from /docs/node/call-service.md -->
<script type="text/x-red" data-help-name="server"></script>
